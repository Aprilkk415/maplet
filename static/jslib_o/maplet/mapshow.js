// Generated by CoffeeScript 1.11.1
(function() {
  var del_geojson, del_layout, reply_del, reply_it, reply_zan;

  reply_zan = function(sig, reply_id, id_num) {
    var AjaxUrl, zans;
    id_num = id_num.toString();
    zans = $("#text_zan").val();
    AjaxUrl = "/" + sig + "/toreply/zan/" + reply_id;
    return $.getJSON(AjaxUrl, function(Json) {
      if (Json.text_zan !== 0) {
        return $("#text_zan_" + id_num).html(Json.text_zan);
      }
    });
  };

  reply_del = function(sig, reply_id, id_num) {
    var AjaxUrl;
    id_num = id_num.toString();
    AjaxUrl = "/" + sig + "/toreply/delete_reply/" + reply_id;
    return $.getJSON(AjaxUrl, function(Json) {
      return $("#del_zan_" + id_num).html("");
    });
  };

  reply_it = function(sig, view_id) {
    var txt;
    txt = $("#cnt_md").val();
    if (txt.length < 30) {
      return;
    }
    $.post("/" + sig + "/toreply/add/" + view_id, {
      cnt_md: txt
    }, function(result) {
      var msg_json;
      msg_json = $.parseJSON(result);
      return $("#pinglun").load("/reply/get/" + msg_json.pinglun);
    });
    $("#cnt_md").val("");
    $("#cnt_md").attr("disabled", true);
    return $("#btn_submit_reply").attr("disabled", true);
  };

  del_layout = function(layout_id) {
    return $.ajax({
      url: "/layout/delete/" + layout_id,
      type: "GET",
      cache: false,
      data: {},
      dataType: "html",
      timeout: 1000,
      error: function() {
        return alert("删除失败！");
      },
      success: function(result) {
        return alert("删除成功！暂请手动刷新页面！");
      }
    });
  };

  del_geojson = function(gson_id) {
    return $.ajax({
      url: "/geojson/delete/" + gson_id,
      type: "GET",
      cache: false,
      data: {},
      dataType: "html",
      timeout: 1000,
      error: function() {
        return alert("删除失败！");
      },
      success: function(result) {
        return alert("删除成功，暂请手动刷新页面！");
      }
    });
  };

  $(document).ready(function() {
    var AjaxUrl, baseMaps, cities, drawnItems, map, nexrad, onMapClick, onZoomend, osm, overlayMaps, popup;
    $("#act_collect").click(function() {
      return $.ajax({
        url: "/collect/" + map_uid,
        type: "GET",
        cache: false,
        data: {},
        dataType: "html",
        timeout: 1000,
        error: function() {
          return alert("请登陆后进行收藏！");
        },
        success: function(result) {
          $("#text_collect").text("成功收藏");
          return $("#text_collect").css("color", "red");
        }
      });
    });
    $("#act_eval0").click(function() {
      return $.ajax({
        url: "/evaluate/" + map_uid + "/0",
        type: "GET",
        cache: false,
        data: {},
        dataType: "html",
        timeout: 1000,
        error: function() {
          return alert("请登陆后进行评价！");
        },
        success: function(result) {
          result = JSON.parse(result);
          $("#eval0").text(result["eval0"]);
          return $("#eval1").text(result["eval1"]);
        }
      });
    });
    $("#act_eval1").click(function() {
      return $.ajax({
        url: "/evaluate/" + map_uid + "/1",
        type: "GET",
        cache: false,
        data: {},
        dataType: "html",
        timeout: 1000,
        error: function() {
          return alert("请登陆后进行评价！");
        },
        success: function(result) {
          result = JSON.parse(result);
          $("#eval0").text(result["eval0"]);
          return $("#eval1").text(result["eval1"]);
        }
      });
    });
    $("#btn_overlay").click(function() {
      var sig_map_1, sig_map_2, url_new;
      sig_map_1 = $("#over_map_1").val();
      sig_map_2 = $("#over_map_2").val();
      url_new = "/map/overlay/" + map_uid + "/" + sig_map_1;
      if (sig_map_2 !== "") {
        url_new = url_new + "/" + sig_map_2;
      }
      return window.location.href = url_new;
    });
    $("#save_view").click(function() {
      var view_url;
      view_url = $("#current_view_url").attr("href").split("?")[1] + "&map=" + map_uid;
      return $.ajax({
        url: "/layout/save",
        type: "POST",
        cache: false,
        data: view_url,
        dataType: "html",
        timeout: 1000,
        error: function() {
          $("#current_view_url").text("请登陆后保存视图，或检查是否已经开始浏览地图！");
          return $("#current_view_url").css("color", "red");
        },
        success: function(result) {
          return $("#current_view_url").text("视图已成功保存！");
        }
      });
    });
    onMapClick = function(e) {
      var cmap_coor, currentZoom, link_str;
      popup.setLatLng(e.latlng);
      popup.setContent("坐标位置" + e.latlng.toString());
      currentZoom = map.getZoom();
      cmap_coor = e.latlng;
      link_str = "http://www.maplet.org/map/" + map_uid + "?zoom=" + currentZoom + "&lat=" + cmap_coor.lat.toFixed(4) + "&lon=" + cmap_coor.lng.toFixed(4) + "&marker=1";
      if (geojsonid !== "") {
        link_str = link_str + "&geojson=" + geojsonid;
      }
      $("#current_view_url").html(link_str);
      $("#current_view_url").attr("href", link_str);
      return popup.openOn(map);
    };
    onZoomend = function() {
      var cmap_coor, currentZoom, link_str;
      currentZoom = map.getZoom();
      cmap_coor = map.getCenter();
      link_str = "http://www.maplet.org/map/" + map_uid + "?zoom=" + currentZoom + "&lat=" + cmap_coor.lat.toFixed(4) + "&lon=" + cmap_coor.lng.toFixed(4);
      if (geojsonid !== "") {
        link_str = link_str + "&geojson=" + geojsonid;
      }
      $("#current_view_url").css("color", "");
      $("#current_view_url").html(link_str);
      return $("#current_view_url").attr("href", link_str);
    };
    popup = L.popup();
    cities = new L.LayerGroup();
    drawnItems = new L.FeatureGroup();
    nexrad = L.tileLayer.wms("http://wcs.osgeo.cn:8088/service?", {
      layers: "maplet_" + map_uid,
      format: "image/png",
      transparent: true,
      attribution: "Maplet"
    });
    osm = L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiYnVrdW4iLCJhIjoiY2lqeWFjZmo4MXFubndka2lzcnZ1M2tzciJ9.C1dZUQkRZSIEKfg-DaFYpw", {
      maxZoom: 18,
      attribution: "Map data &copy; <a href=\"http://openstreetmap.org\">OpenStreetMap</a> contributors, " + "<a href=\"http://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA</a>, " + "Imagery © <a href=\"http://mapbox.com\">Mapbox</a>",
      id: "mapbox.streets"
    });
    nexrad.addTo(cities);
    osm.addTo(cities);
    map = L.map("map", {
      center: [vlat, vlon],
      zoom: vzoom_current,
      maxZoom: vzoom_max,
      minZoom: vzoom_min,
      layers: [cities]
    });
    if (vmarker.toString() === "1") {
      L.marker([vlat, vlon]).addTo(map);
    }
    AjaxUrl = "/geojson/gson/" + geojsonid;
    if (geojsonid !== "") {
      $.getJSON(AjaxUrl, function(gjson) {
        var gson_arr;
        gson_arr = new Array();
        $.each(gjson, function(i, item) {
          return gson_arr[i] = item;
        });
        return L.geoJson(gson_arr).addTo(map);
      });
    }
    map.on("zoomend", onZoomend);
    map.on("moveend", onZoomend);
    map.on("click", onMapClick);
    baseMaps = {
      osm: osm
    };
    overlayMaps = {
      "专题地图": nexrad
    };
    return L.control.layers(baseMaps, overlayMaps).addTo(map);
  });

}).call(this);
